<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AIチャット（進捗表示付き）</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #202123; color: white; }
        #output { background: #343541; padding: 15px; min-height: 150px; margin: 10px 0; border-radius: 8px; white-space: pre-wrap; border: 1px solid #555; }
        #progress-container { width: 100%; background: #444; border-radius: 10px; margin: 10px 0; display: none; }
        #progress-bar { width: 0%; height: 20px; background: #10a37f; border-radius: 10px; text-align: center; line-height: 20px; font-size: 12px; }
        textarea { width: 100%; height: 80px; background: #40414f; color: white; border: 1px solid #555; border-radius: 5px; padding: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #10a37f; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #555; }
    </style>
</head>
<body>
    <h1>My Local AI</h1>
    <div id="progress-container">
        <div id="progress-bar">0%</div>
    </div>
    <div id="output">モデルを読み込み中...</div>
    <textarea id="input" placeholder="質問を入力..."></textarea>
    <button id="sendBtn" disabled>準備中...</button>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.3.1';

        const outputDiv = document.getElementById('output');
        const sendBtn = document.getElementById('sendBtn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        async function init() {
            try {
                progressContainer.style.display = 'block';
                
                // 読み込み状況をバーに反映させる設定
                const generator = await pipeline('text-generation', 'onnx-community/Llama-3.2-1B-Instruct-q4f16', {
                    device: 'wasm',
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const p = Math.round(data.progress);
                            progressBar.style.width = p + '%';
                            progressBar.innerText = p + '%';
                        }
                    }
                });

                outputDiv.innerText = "準備完了！";
                sendBtn.disabled = false;
                progressContainer.style.display = 'none';

                window.ask = async () => {
                    const text = document.getElementById('input').value;
                    if(!text) return;
                    outputDiv.innerText = "思考中...";
                    const output = await generator([{ role: "user", content: text }], { max_new_tokens: 128 });
                    outputDiv.innerText = output[0].generated_text.at(-1).content;
                };
                sendBtn.onclick = window.ask;

            } catch (e) {
                outputDiv.innerText = "エラー: " + e.message;
            }
        }
        init();
    </script>
</body>
</html>
